<% content_for :header_tags do %>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

     <style>
    /* Caja cerrada (lo que se ve cuando el combo NO está desplegado) */
    body.controller-timesheets .select2-container--default .select2-selection--single {
      background-color: #ffffff !important;
      border: 1px solid #555555 !important;
      border-radius: 3px !important;
      height: 28px !important;
    }

    body.controller-timesheets .select2-container--default .select2-selection--single .select2-selection__rendered {
      background-color: #ffffff !important;
      color: #222222 !important;
      line-height: 26px !important;
      padding-left: 6px !important;
      font-weight: 500;
    }

    body.controller-timesheets .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 26px !important;
    }

    /* Lista desplegable (opciones) */
    body.controller-timesheets .select2-container--default .select2-results__option {
      background-color: #ffffff;
      color: #333333;
    }

    body.controller-timesheets .select2-container--default .select2-results__option--highlighted[aria-selected] {
      background-color: #e0f0ff !important;
      color: #000000 !important;
    }
  </style>


    <script>
        document.addEventListener('DOMContentLoaded', function() {

        $(document).on('change', '.project-select', function() {
            var projectId = $(this).val();
            var rowIndex  = $(this).data('row-index');

            var issueSelect = $('#issue-select-' + rowIndex);

            if (!issueSelect.length) return;

            // limpiar opciones actuales
            issueSelect.empty().trigger('change');

            if (!projectId) return;

            // cargar issues vía AJAX
            $.getJSON('/timesheets/project_issues', { project_id: projectId }, function(data) {
            data.forEach(function(item) {
                var option = new Option(item.text, item.id, false, false);
                issueSelect.append(option);
            });

            issueSelect.trigger('change');
            });
        });

        });
    </script>


  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof $ !== 'undefined' && $.fn.select2) {
        $('select.timesheets-select').select2({
          width: 'resolve',
          allowClear: true,
          placeholder: ''
        });
      }
    });
  </script>
<% end %>


<h2>Hojas de Tiempo</h2>

<%= form_tag(edit_timesheet_path, method: :get, id: 'timesheet_filter_form') do %>
  <div class="box tabular" style="background-color:#f6f6f6; padding:10px; border:1px solid #e4e4e4;">

    <p>
      <label style="font-weight:bold;">Usuario</label>
      <%= select_tag 'user_id',
            options_from_collection_for_select(@users, 'id', 'name', @selected_user.id),
            onchange: 'this.form.submit();',
            class: 'timesheets-select' %>
    </p>

    <p>
      <label style="font-weight:bold;">Fecha de inicio</label>
      <%= date_field_tag 'start_date', @week_start, size: 10 %>

      &nbsp;&nbsp;

      <% prev_week = @week_start - 7 %>
      <% next_week = @week_start + 7 %>

      <%= link_to '&laquo; Anterior'.html_safe,
                  edit_timesheet_path(user_id: @selected_user.id, start_date: prev_week),
                  class: 'icon icon-previous' %>

      &nbsp;

      <%= link_to 'Siguiente &raquo;'.html_safe,
                  edit_timesheet_path(user_id: @selected_user.id, start_date: next_week),
                  class: 'icon icon-next' %>

      &nbsp;&nbsp;

      <%= submit_tag 'Aceptar', class: 'small', name: nil %>
    </p>

  </div>
<% end %>

<%= form_tag(timesheets_save_path, method: :post, id: 'timesheet_edit_form') do %>
  <div class="box">
    <%= hidden_field_tag :user_id, @selected_user.id %>
    <%= hidden_field_tag :week_start, @week_start %>

    <div style="text-align:right; margin-bottom:5px;">
      <a href="#" id="add_row_top" class="icon icon-add">Add Row</a>
    </div>

    <table class="list">
      <thead>
        <tr>
          <th>Proyecto</th>
          <th>Petición</th>
          <th>Actividad</th>
          <th>Comentario</th>
          <% day_names = I18n.t('date.abbr_day_names') %>
          <% @week_days.each do |day| %>
            <th style="text-align:center;">
              <%= day_names[day.wday] %><br/>
              <%= format_date(day) %>
            </th>
          <% end %>
          <th style="text-align:center;">&nbsp;</th>
        </tr>
      </thead>
      <tbody id="timesheet_rows">
        <% @rows.each_with_index do |row, idx| %>
          <tr data-index="<%= idx %>">
            <td>
                <% selected_project_id = row[:project]&.id || @current_project&.id %>
                <%= select_tag "rows[#{idx}][project_id]",
                        options_from_collection_for_select(@editable_projects, 'id', 'name', selected_project_id),
                        include_blank: true,
                        class: 'timesheets-select project-select',
                        data: { row_index: idx },
                        style: 'width: 260px;' %>
            </td>

            <td>
                <% issue_options = @issues_for_project.map do |iss|
                ["Tarea ##{iss.id}: #{truncate(iss.subject, length: 60)}", iss.id]
                end %>

                <%= select_tag "rows[#{idx}][issue_id]",
                    options_for_select(issue_options, row[:issue]&.id),
                    include_blank: true,
                    class: 'timesheets-select issue-select',
                    id: "issue-select-#{idx}",
                    style: 'width: 320px;' %>
            </td>

            <td>
              <%= select_tag "rows[#{idx}][activity_id]",
                    options_from_collection_for_select(@activities_hours, 'id', 'name', row[:activity]&.id || @activities_hours.first&.id),
                    include_blank: false,
                    style: 'width: 100px;' %>
            </td>
            <td>
              <%= text_field_tag "rows[#{idx}][comments]", row[:comments],
                    size: 40,
                    style: 'width: 300px;' %>
            </td>

            <% @week_days.each do |day| %>
              <% hours = row[:daily_hours][day] || 0.0 %>
              <td style="text-align:center;">
                <%= number_field_tag "rows[#{idx}][hours][#{day}]", hours,
                      step: 0.25, min: 0, style: 'width:60px;' %>
              </td>
            <% end %>

            <td style="text-align:center;">
              <a href="#" class="remove-row icon icon-del" title="Eliminar fila"></a>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
      <div>
        <%= submit_tag 'Guardar', class: 'button', name: 'save' %>
        <%= submit_tag 'Save and continue', class: 'button', name: 'save_and_continue' %>
      </div>
      <div>
        <a href="#" id="add_row_bottom" class="icon icon-add">Add Row</a>
      </div>
    </div>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  function addRow() {
    var tbody = document.getElementById('timesheet_rows');
    if (!tbody) return;

    var rows = tbody.querySelectorAll('tr');
    var lastRow = rows[rows.length - 1];
    if (!lastRow) return;

    var newIndex = rows.length;
    var clone = lastRow.cloneNode(true);

    clone.setAttribute('data-index', newIndex);

    // actualizar names de los inputs al nuevo índice
    clone.querySelectorAll('input, select').forEach(function(el) {
      if (el.name) {
        el.name = el.name.replace(/rows\[\d+\]/, 'rows[' + newIndex + ']');
      }
      if (el.type === 'number' || el.type === 'text') {
        el.value = '';
      }
    });

    tbody.appendChild(clone);
  }

  var addTop = document.getElementById('add_row_top');
  var addBottom = document.getElementById('add_row_bottom');

  if (addTop) addTop.addEventListener('click', function(e) {
    e.preventDefault();
    addRow();
  });

  if (addBottom) addBottom.addEventListener('click', function(e) {
    e.preventDefault();
    addRow();
  });

  document.getElementById('timesheet_rows').addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-row')) {
      e.preventDefault();
      var tr = e.target.closest('tr');
      if (tr && this.querySelectorAll('tr').length > 1) {
        tr.remove();
      }
    }
  });
});
</script>
