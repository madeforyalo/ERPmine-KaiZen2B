<% content_for :header_tags do %>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof $ !== 'undefined' && $.fn.select2) {
        $('select.timesheets-select').select2({
          width: 'resolve',
          allowClear: true,
          placeholder: ''
        });
      }
    });
  </script>
<% end %>


<h2>Hojas de Tiempo</h2>

<%= form_tag(edit_timesheet_path, method: :get, id: 'timesheet_filter_form') do %>
  <div class="box tabular" style="background-color:#f6f6f6; padding:10px; border:1px solid #e4e4e4;">

    <p>
      <label style="font-weight:bold;">Usuario</label>
      <%= select_tag 'user_id',
            options_from_collection_for_select(@users, 'id', 'name', @selected_user.id),
            onchange: 'this.form.submit();',
            class: 'timesheets-select' %>
    </p>

    <p>
      <label style="font-weight:bold;">Fecha de inicio</label>
      <%= date_field_tag 'start_date', @week_start, size: 10 %>

      &nbsp;&nbsp;

      <% prev_week = @week_start - 7 %>
      <% next_week = @week_start + 7 %>

      <%= link_to '&laquo; Anterior'.html_safe,
                  edit_timesheet_path(user_id: @selected_user.id, start_date: prev_week),
                  class: 'icon icon-previous' %>

      &nbsp;

      <%= link_to 'Siguiente &raquo;'.html_safe,
                  edit_timesheet_path(user_id: @selected_user.id, start_date: next_week),
                  class: 'icon icon-next' %>

      &nbsp;&nbsp;

      <%= submit_tag 'Aceptar', class: 'small', name: nil %>
    </p>

  </div>
<% end %>

<%= form_tag(timesheets_save_path, method: :post, id: 'timesheet_edit_form') do %>
  <div class="box">
    <%= hidden_field_tag :user_id, @selected_user.id %>
    <%= hidden_field_tag :week_start, @week_start %>

    <div style="text-align:right; margin-bottom:5px;">
      <a href="#" id="add_row_top" class="icon icon-add">Add Row</a>
    </div>

    <table class="list">
      <thead>
        <tr>
          <th>Proyecto</th>
          <th>Petición</th>
          <th>Actividad</th>
          <th>Comentario</th>
          <% day_names = I18n.t('date.abbr_day_names') %>
          <% @week_days.each do |day| %>
            <th style="text-align:center;">
              <%= day_names[day.wday] %><br/>
              <%= format_date(day) %>
            </th>
          <% end %>
          <th style="text-align:center;">&nbsp;</th>
        </tr>
      </thead>
      <tbody id="timesheet_rows">
        <% @rows.each_with_index do |row, idx| %>
          <tr data-index="<%= idx %>">
            <td>
              <%= select_tag "rows[#{idx}][project_id]",
                options_from_collection_for_select(@editable_projects, 'id', 'name', row[:project]&.id),
                include_blank: true,
                style: 'width: 220px;',
                class: 'timesheets-select' %>
            </td>
            <td>
              <!-- por ahora: ID de la petición (Issue) en crudo -->
              <%= text_field_tag "rows[#{idx}][issue_id]", row[:issue]&.id, size: 6, style: 'width: 80px;' %>
            </td>
            <td>
              <%= select_tag "rows[#{idx}][activity_id]",
                    options_from_collection_for_select(@activities_hours, 'id', 'name', row[:activity]&.id || @activities_hours.first&.id),
                    include_blank: false,
                    style: 'width: 100px;',
                    class: 'timesheets-select' %>
            </td>
            <td>
              <%= text_field_tag "rows[#{idx}][comments]", row[:comments],
                    size: 40,
                    style: 'width: 300px;' %>
            </td>

            <% @week_days.each do |day| %>
              <% hours = row[:daily_hours][day] || 0.0 %>
              <td style="text-align:center;">
                <%= number_field_tag "rows[#{idx}][hours][#{day}]", hours,
                      step: 0.25, min: 0, style: 'width:60px;' %>
              </td>
            <% end %>

            <td style="text-align:center;">
              <a href="#" class="remove-row icon icon-del" title="Eliminar fila"></a>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
      <div>
        <%= submit_tag 'Guardar', class: 'button', name: 'save' %>
        <%= submit_tag 'Save and continue', class: 'button', name: 'save_and_continue' %>
      </div>
      <div>
        <a href="#" id="add_row_bottom" class="icon icon-add">Add Row</a>
      </div>
    </div>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  function addRow() {
    var tbody = document.getElementById('timesheet_rows');
    if (!tbody) return;

    var rows = tbody.querySelectorAll('tr');
    var lastRow = rows[rows.length - 1];
    if (!lastRow) return;

    var newIndex = rows.length;
    var clone = lastRow.cloneNode(true);

    clone.setAttribute('data-index', newIndex);

    // actualizar names de los inputs al nuevo índice
    clone.querySelectorAll('input, select').forEach(function(el) {
      if (el.name) {
        el.name = el.name.replace(/rows\[\d+\]/, 'rows[' + newIndex + ']');
      }
      if (el.type === 'number' || el.type === 'text') {
        el.value = '';
      }
    });

    tbody.appendChild(clone);
  }

  var addTop = document.getElementById('add_row_top');
  var addBottom = document.getElementById('add_row_bottom');

  if (addTop) addTop.addEventListener('click', function(e) {
    e.preventDefault();
    addRow();
  });

  if (addBottom) addBottom.addEventListener('click', function(e) {
    e.preventDefault();
    addRow();
  });

  document.getElementById('timesheet_rows').addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-row')) {
      e.preventDefault();
      var tr = e.target.closest('tr');
      if (tr && this.querySelectorAll('tr').length > 1) {
        tr.remove();
      }
    }
  });
});
</script>
