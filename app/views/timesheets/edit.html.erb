<% content_for :header_tags do %>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

     <style>
    /* Caja cerrada (lo que se ve cuando el combo NO está desplegado) */
    body.controller-timesheets .select2-container--default .select2-selection--single {
      background-color: #ffffff !important;
      border: 1px solid #555555 !important;
      border-radius: 3px !important;
      height: 28px !important;
    }

    body.controller-timesheets .select2-container--default .select2-selection--single .select2-selection__rendered {
      background-color: #ffffff !important;
      color: #222222 !important;
      line-height: 26px !important;
      padding-left: 6px !important;
      font-weight: 500;
    }

    body.controller-timesheets .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 26px !important;
    }

    /* Lista desplegable (opciones) */
    body.controller-timesheets .select2-container--default .select2-results__option {
      background-color: #ffffff;
      color: #333333;
    }

    body.controller-timesheets .select2-container--default .select2-results__option--highlighted[aria-selected] {
      background-color: #e0f0ff !important;
      color: #000000 !important;
    }
  </style>


    <script>
        document.addEventListener('DOMContentLoaded', function() {

            $(document).on('change', '.project-select', function() {
                var projectId = $(this).val();
                var rowIndex  = $(this).data('row-index');

                var issueSelect    = $('#issue-select-' + rowIndex);
                var activitySelect = $('#activity-select-' + rowIndex);

                // limpiar combos actuales
                if (issueSelect.length) {
                    issueSelect.empty().trigger('change');
                }
                if (activitySelect.length) {
                    activitySelect.empty().trigger('change');
                }

                if (!projectId) return;

                // 1) Cargar issues abiertas del proyecto
                if (issueSelect.length) {
                    $.getJSON('/timesheets/project_issues', { project_id: projectId }, function(data) {
                    data.forEach(function(item) {
                        var opt = new Option(item.text, item.id, false, false);
                        issueSelect.append(opt);
                    });
                    issueSelect.trigger('change');
                    });
                }

                // 2) Cargar actividades del proyecto
    //             if (activitySelect.length) {
    //                 $.getJSON('/timesheets/project_activities', { project_id: projectId }, function(data) {
    //                 data.forEach(function(item) {
    //                     var opt = new Option(item.name, item.id, false, false);
    //                     activitySelect.append(opt);
    //                 });
    //                 activitySelect.trigger('change');
    //                 });
    //             }
            });
        });
    </script>


  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof $ !== 'undefined' && $.fn.select2) {
        $('select.timesheets-select').select2({
          width: 'resolve',
          allowClear: true,
          placeholder: ''
        });
      }
    });
  </script>
<% end %>


<h2>Hojas de Tiempo</h2>

<%= form_tag(edit_timesheet_path, method: :get, id: 'timesheet_filter_form') do %>
  <div class="box tabular" style="background-color:#f6f6f6; padding:10px; border:1px solid #e4e4e4;">

    <p>
      <label style="font-weight:bold;">Usuario</label>
      <%= select_tag 'user_id',
            options_from_collection_for_select(@users, 'id', 'name', @selected_user.id),
            onchange: 'this.form.submit();',
            class: 'timesheets-select' %>
    </p>

    <p>
      <label style="font-weight:bold;">Fecha de inicio</label>
      <%= date_field_tag 'start_date', @week_start, size: 10 %>

      &nbsp;&nbsp;

      <% prev_week = @week_start - 7 %>
      <% next_week = @week_start + 7 %>

      <%= link_to '&laquo; Anterior'.html_safe,
                  edit_timesheet_path(user_id: @selected_user.id, start_date: prev_week),
                  class: 'icon icon-previous' %>

      &nbsp;

      <%= link_to 'Siguiente &raquo;'.html_safe,
                  edit_timesheet_path(user_id: @selected_user.id, start_date: next_week),
                  class: 'icon icon-next' %>

      &nbsp;&nbsp;

      <%= submit_tag 'Aceptar', class: 'small', name: nil %>
    </p>

  </div>
<% end %>

<%= form_tag(timesheets_save_path, method: :post, id: 'timesheet_edit_form') do %>
  <div class="box">
    <%= hidden_field_tag :user_id, @selected_user.id %>
    <%= hidden_field_tag :week_start, @week_start %>

    <div style="text-align:right; margin-bottom:5px;">
      <a href="#" id="add_row_top" class="icon icon-add">Add Row</a>
    </div>

    <table class="list">
      <thead>
        <tr>
          <th><%= l(:label_project) %></th>
          <th><%= l(:label_issue) %></th>
          <th><%= l(:field_activity) %></th>
          <th><%= l(:field_comments) %></th>
          <% @week_days.each do |day| %>
            <th style="text-align:center;">
              <%= day_name(day.cwday % 7) %><br/>
              <%= format_date(day) %>
            </th>
          <% end %>
          <th></th>
        </tr>
      </thead>

      <tbody id="timesheet_rows">
        <% @rows.each_with_index do |row, idx| %>
          <tr data-index="<%= idx %>">
            <!-- Proyecto -->
            <td>
              <% selected_project_id = row[:project]&.id || @current_project&.id %>
              <%= select_tag "rows[#{idx}][project_id]",
                    options_from_collection_for_select(@editable_projects, 'id', 'name', selected_project_id),
                    include_blank: true,
                    class: 'timesheets-select project-select',
                    data: { row_index: idx },
                    style: 'width: 260px;' %>
            </td>

            <!-- Petición -->
            <td>
            <% issue_collection = @issues_for_project || [] %>
            <% issue_options = issue_collection.map do |iss|
                ["Tarea ##{iss.id}: #{truncate(iss.subject, length: 60)}", iss.id]
                end %>

            <%= select_tag "rows[#{idx}][issue_id]",
                    options_for_select(issue_options, row[:issue]&.id),
                    include_blank: true,
                    class: 'timesheets-select issue-select',
                    id: "issue-select-#{idx}",
                    style: 'width: 320px;' %>
            </td>

            <!-- Actividad -->
            <td>
            <% activity_collection = @activities_for_project || [] %>
            <% activity_options = activity_collection.map { |a| [a.name, a.id] } %>

            <%= select_tag "rows[#{idx}][activity_id]",
                    options_for_select(activity_options, row[:activity]&.id),
                    include_blank: true,
                    class: 'timesheets-select activity-select',
                    id: "activity-select-#{idx}",
                    style: 'width: 120px;' %>
            </td>

            <!-- Comentario -->
            <td>
              <%= text_field_tag "rows[#{idx}][comments]", row[:comments],
                    style: 'width: 260px;' %>
            </td>

            <!-- Horas por día -->
            <% @week_days.each do |day| %>
              <% hours = row[:daily_hours][day] || 0.0 %>
              <td style="text-align:center;">
                <%= number_field_tag "rows[#{idx}][hours][#{day}]", hours,
                      step: 0.25, min: 0, style: 'width:60px;',
                      class: 'hours-input',
                      data: { day: day } %>
              </td>
            <% end %>

            <!-- Borrar fila -->
            <td style="text-align:center;">
              <a href="#" class="icon icon-del remove-row"></a>
            </td>
          </tr>
        <% end %>
      </tbody>

      <tfoot>
        <tr id="totals-row">
          <!-- columnas de texto -->
          <td colspan="4" style="text-align:right; font-weight:bold;">
            Total
          </td>

          <!-- subtotales por día -->
          <% @week_days.each do |day| %>
            <td class="day-total"
                data-day="<%= day %>"
                style="text-align:center; font-weight:bold;">
              0.00
            </td>
          <% end %>

          <!-- total general -->
          <td style="text-align:center; font-weight:bold;">
            Total: <span id="grand-total">0.00</span>
          </td>
        </tr>
      </tfoot>
    </table>


    <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
      <div>
        <%= submit_tag 'Guardar', class: 'button', name: 'save' %>
        <%= submit_tag 'Save and continue', class: 'button', name: 'save_and_continue' %>
      </div>
      <div>
        <a href="#" id="add_row_bottom" class="icon icon-add">Add Row</a>
      </div>
    </div>
  </div>
<% end %>

<script>
    document.addEventListener('DOMContentLoaded', function() {

  // === 1) Totales por día y total general ===
  
    var dayTotals  = {};
    var grandTotal = 0.0;

    $('#timesheet_rows input.hours-input').each(function() {
      var v = $(this).val();
      if (!v) return;
    function recalcTotals() {
    var dayTotals  = {};
    var grandTotal = 0.0;

    $('#timesheet_rows input.hours-input').each(function() {
        var v = $(this).val();
        if (!v) return;

        // soportar 1,5 y 1.5
        var hours = parseFloat(String(v).replace(',', '.'));
        if (isNaN(hours)) return;

        // usamos SIEMPRE cadena como clave
        var dayKey = String($(this).data('day'));

        if (!dayTotals[dayKey]) dayTotals[dayKey] = 0.0;

        dayTotals[dayKey] += hours;
        grandTotal        += hours;
    });

    // actualizar subtotales por día
    $('#totals-row .day-total').each(function() {
        var dayKey = String($(this).data('day'));
        var total  = dayTotals[dayKey] || 0.0;
        $(this).text(total.toFixed(2));
    });

    // actualizar total general
    $('#grand-total').text(grandTotal.toFixed(2));
    }
    }

  // === 2) Inicializar Select2 ===
  function initSelect2ForCtx($ctx) {
    if (typeof $ === 'undefined' || !$.fn.select2) return;

    $ctx.find('select.timesheets-select').each(function() {
      var $s = $(this);
      if ($s.data('select2')) return; // evitar doble init

      $s.select2({
        width: 'style',
        allowClear: true,
        placeholder: ''
      });
    });
  }

  // === 3) Agregar fila ===
  function addRow() {
    var $tbody = $('#timesheet_rows');
    if (!$tbody.length) return;

    var $rows = $tbody.find('tr');
    var $last = $rows.last();
    if (!$last.length) return;

    var newIndex = $rows.length;
    var $clone   = $last.clone();

    // nuevo índice de fila
    $clone.attr('data-index', newIndex);

    // eliminar wrappers de Select2 clonados y mostrar selects reales
    $clone.find('span.select2').remove();
    $clone.find('select').show();

    // reindexar names/ids y limpiar valores de inputs
    $clone.find('input, select').each(function() {
      var $el = $(this);

      // actualizar name rows[0] -> rows[newIndex]
      if ($el.attr('name')) {
        $el.attr('name', $el.attr('name').replace(/rows\[\d+\]/, 'rows[' + newIndex + ']'));
      }

      // actualizar id ...-0 -> ...-newIndex (para issue-select-XX, etc.)
      if ($el.attr('id')) {
        $el.attr('id', $el.attr('id').replace(/-\d+$/, '-' + newIndex));
      }

      // limpiar valores de texto / número
      if ($el.is('input[type="number"], input[type="text"]')) {
        $el.val('');
      }
    });

    // actualizar data-row-index del proyecto de la nueva fila
    $clone.find('.project-select').data('row-index', newIndex);

    $tbody.append($clone);

    // inicializar Select2 en la nueva fila
    initSelect2ForCtx($clone);
    recalcTotals();
  }

  // === 4) Eventos ===

  // Botones Add Row (arriba y abajo)
  $('#add_row_top, #add_row_bottom').on('click', function(e) {
    e.preventDefault();
    addRow();
  });

  // Eliminar fila (dejamos al menos 1)
  $('#timesheet_rows').on('click', '.remove-row', function(e) {
    e.preventDefault();
    var $tbody = $('#timesheet_rows');
    var $rows  = $tbody.find('tr');
    if ($rows.length > 1) {
      $(this).closest('tr').remove();
      recalcTotals();
    }
  });

  // Cambio de proyecto -> recargar Peticiones vía AJAX
  $(document).on('change', '.project-select', function() {
    var projectId = $(this).val();
    var rowIndex  = $(this).data('row-index');
    var issueSelect = $('#issue-select-' + rowIndex);

    if (!issueSelect.length) return;

    // limpiar opciones actuales
    issueSelect.empty().trigger('change');

    if (!projectId) return;

    $.getJSON('/timesheets/project_issues', { project_id: projectId }, function(data) {
      data.forEach(function(item) {
        var opt = new Option(item.text, item.id, false, false);
        issueSelect.append(opt);
      });
      issueSelect.trigger('change');
    });
  });

  // Recalcular totales al modificar horas
  $(document).on('input', 'input.hours-input', function() {
    recalcTotals();
  });

  // === 5) Init al cargar la página ===
  initSelect2ForCtx($(document));
  recalcTotals();
});
</script>


